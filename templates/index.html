<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlowBook Translator</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f4f4f9; }
        .container { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        /* Drag and Drop Zone */
        #drop-zone {
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            color: #666;
            transition: border-color 0.3s, background-color 0.3s;
            cursor: pointer;
            margin-bottom: 20px;
        }
        #drop-zone.dragover { border-color: #3498db; background-color: #ebf5fb; }
        #file-input { display: none; }

        /* Status & Info */
        #status-area { margin-top: 20px; display: none; }
        .info-bar { display: flex; justify-content: space-between; flex-wrap: wrap; margin-bottom: 15px; font-weight: bold; color: #333; }
        .info-bar > span { margin-right: 15px; margin-bottom: 5px; }
        
        /* Progress Bar */
        .progress-container { width: 100%; background-color: #e0e0e0; border-radius: 5px; margin-bottom: 15px; }
        .progress-bar {
            width: 0%; height: 20px; background-color: #4CAF50; border-radius: 5px;
            text-align: center; line-height: 20px; color: white; font-size: 0.9em;
            transition: width 0.5s ease-in-out;
        }

        /* Chunk Grid */
        .chunk-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(30px, 1fr)); gap: 5px; margin-top: 20px; }
        .chunk-card {
            width: 30px; height: 30px; border: 1px solid #ddd; border-radius: 3px;
            font-size: 0.7em; display: flex; align-items: center; justify-content: center;
            transition: background 0.3s;
            position: relative;
            cursor: help; /* Indicate hover for title */
        }
        .chunk-card.waiting { background: #f0f0f0; color: #888; }
        .chunk-card.processing { background: #fff3cd; border-color: #ffeeba; color: #856404; }
        .chunk-card.translated { background: #d4edda; border-color: #c3e6cb; color: #155724; }
        
        /* Download Button */
        #download-btn {
            display: none; width: 100%; padding: 15px; background-color: #28a745; color: white;
            text-align: center; text-decoration: none; font-size: 1.2em; border-radius: 5px; margin-top: 20px;
        }
        #download-btn:hover { background-color: #218838; }
    </style>
</head>
<body>

<div class="container">
    <h1>FlowBook Translator</h1>
    <p>Drag & drop your PDF or EPUB file to translate.</p>

    <div id="drop-zone">
        <p>Drag file here or click to upload</p>
        <input type="file" id="file-input" accept=".pdf,.epub">
    </div>

    <div id="status-area">
        <div class="info-bar">
            <span id="lang-display">Language: Detecting...</span>
            <span id="total-chunks-display">Chunks: 0</span>
            <span id="estimated-time-display">Est. Time: --</span>
            <span id="progress-display">Status: Ready</span>
        </div>
        <div class="progress-container">
            <div class="progress-bar" id="global-progress-bar">0%</div>
        </div>
        <div id="chunk-container" class="chunk-grid"></div>
        <a id="download-btn" href="#" target="_blank">Download Translated File</a>
    </div>
</div>

<script>
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const statusArea = document.getElementById('status-area');
    const chunkContainer = document.getElementById('chunk-container');
    const langDisplay = document.getElementById('lang-display');
    const totalChunksDisplay = document.getElementById('total-chunks-display');
    const estimatedTimeDisplay = document.getElementById('estimated-time-display');
    const progressDisplay = document.getElementById('progress-display');
    const globalProgressBar = document.getElementById('global-progress-bar');
    const downloadBtn = document.getElementById('download-btn');

    let socket;
    let currentSessionID = null;
    let totalChunks = 0;
    let translatedChunks = 0;

    // Drag & Drop Events
    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
    });
    fileInput.addEventListener('change', (e) => { if (e.target.files.length) handleFile(e.target.files[0]); });

    function handleFile(file) {
        // Reset UI
        statusArea.style.display = 'block';
        chunkContainer.innerHTML = '';
        downloadBtn.style.display = 'none';
        langDisplay.textContent = "Language: Detecting...";
        totalChunksDisplay.textContent = "Chunks: 0";
        estimatedTimeDisplay.textContent = "Est. Time: --";
        progressDisplay.textContent = "Status: Uploading...";
        globalProgressBar.style.width = '0%';
        globalProgressBar.textContent = '0%';
        totalChunks = 0;
        translatedChunks = 0;

        // Connect WS
        if (!socket || socket.readyState !== WebSocket.OPEN) {
            socket = new WebSocket("ws://" + window.location.host + "/ws");
            socket.onmessage = handleWSMessage;
            socket.onopen = () => console.log('WebSocket connection established');
            socket.onclose = () => console.log('WebSocket connection closed');
            socket.onerror = (error) => console.error('WebSocket error:', error);
        }

        // Upload
        const formData = new FormData();
        formData.append("book", file);

        fetch("/translate", { method: "POST", body: formData })
            .then(res => res.json())
            .then(data => {
                currentSessionID = data.session_id;
                console.log("Session started:", currentSessionID);
            })
            .catch(err => console.error("Upload failed:", err));
    }

    function updateGlobalProgress() {
        if (totalChunks > 0) {
            const percentage = Math.round((translatedChunks / totalChunks) * 100);
            globalProgressBar.style.width = `${percentage}%`;
            globalProgressBar.textContent = `${percentage}%`;
        } else {
            globalProgressBar.style.width = '0%';
            globalProgressBar.textContent = '0%';
        }
    }

    function handleWSMessage(event) {
        const msg = JSON.parse(event.data);
        if (msg.session_id !== currentSessionID) return;

        // Update Global Status
        if (msg.status !== 'chunk_update') {
            progressDisplay.textContent = msg.message;
        }

        // Language Detection
        if (msg.detected_lang) {
            langDisplay.textContent = "Language: " + msg.detected_lang;
        }

        // Estimated Time
        if (msg.estimated_time) {
            estimatedTimeDisplay.textContent = "Est. Time: " + msg.estimated_time;
        }

        // Initialize Chunks Grid
        if (msg.total_chunks !== undefined && msg.total_chunks > 0) {
            totalChunks = msg.total_chunks;
            totalChunksDisplay.textContent = `Chunks: ${totalChunks}`;
            chunkContainer.innerHTML = ''; // Clear previous chunks
            for (let i = 0; i < totalChunks; i++) {
                const div = document.createElement('div');
                div.id = `chunk-${i}`;
                div.className = 'chunk-card waiting';
                // div.textContent = i + 1; // Optional: show chunk number
                chunkContainer.appendChild(div);
            }
            updateGlobalProgress();
        }

        // Update Chunk Status
        if (msg.status === 'chunk_update') {
            const el = document.getElementById(`chunk-${msg.chunk_index}`);
            if (el) {
                el.className = `chunk-card ${msg.chunk_status}`;
                if (msg.chunk_status === 'translated') {
                    translatedChunks++;
                    updateGlobalProgress();
                    el.title = msg.translated_text; // Show translated text on hover
                }
            }
        }

        // Completion
        if (msg.status === 'completed' && msg.download_url) {
            downloadBtn.href = msg.download_url;
            downloadBtn.style.display = 'block';
            progressDisplay.textContent = "Status: Completed";
            updateGlobalProgress(); // Ensure 100% on completion
        }
    }
</script>
</body>
</html>