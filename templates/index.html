<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlowBook Translator</title>
    <link href="https://fonts.googleapis.com/css2?family=Rye&family=Spectral:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Spectral', serif; 
            margin: 0; 
            padding: 40px; 
            background-color: #f5e6d3; 
            color: #2c2c2c;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23d4c5b0' fill-opacity='0.4' fill-rule='evenodd'/%3E%3C/svg%3E");
        }
        .container { 
            background: #fffcf5; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 50px; 
            border: 2px solid #5d4037; 
            box-shadow: 0 0 0 5px #fffcf5, 0 0 0 8px #5d4037, 10px 10px 20px rgba(0,0,0,0.2);
            position: relative;
        }
        .container::before {
            content: "";
            display: block;
            border-top: 3px double #5d4037;
            border-bottom: 1px solid #5d4037;
            height: 3px;
            margin-bottom: 30px;
        }
        h1 {
            font-family: 'Rye', serif;
            text-align: center;
            font-weight: 700;
            font-size: 3em;
            margin-bottom: 10px;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: #3e2723;
            text-shadow: 1px 1px 0px #d4af37;
        }
        p.subtitle {
            text-align: center;
            font-style: italic;
            color: #5d4037;
            margin-bottom: 40px;
            font-size: 1.1em;
        }
        
        /* Drag and Drop Zone */
        #drop-zone {
            border: 3px double #8b7d6b;
            background-color: #f4f0e6;
            border-radius: 4px;
            padding: 60px;
            text-align: center;
            color: #8b7d6b;
            transition: all 0.3s;
            cursor: pointer;
            margin-bottom: 20px;
            font-size: 1.2em;
            font-family: 'Rye', serif;
        }
        #drop-zone:hover, #drop-zone.dragover { background-color: #e8e2d2; border-color: #5d4037; color: #5d4037; }
        #file-input { display: none; }

        /* Status & Info */
        #status-area { margin-top: 20px; display: none; }
        .info-bar { 
            display: flex; 
            justify-content: space-between; 
            flex-wrap: wrap; 
            margin-bottom: 15px; 
            font-weight: bold; 
            color: #3e2723;
            border-top: 2px solid #8b7d6b;
            border-bottom: 2px solid #8b7d6b;
            padding: 15px 0;
            font-family: 'Rye', serif;
            font-size: 0.9em;
        }
        .info-bar > span { margin-right: 15px; margin-bottom: 5px; }
        
        /* Progress Bar */
        .progress-container { 
            width: 100%; 
            background-color: #e8e2d2; 
            border: 2px solid #5d4037; 
            height: 25px; 
            margin-bottom: 15px; 
            position: relative;
            border-radius: 4px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
        }
        .progress-bar {
            width: 0%; 
            height: 100%; 
            background-color: #8b7d6b; 
            background-image: linear-gradient(45deg,rgba(255,255,255,.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.15) 50%,rgba(255,255,255,.15) 75%,transparent 75%,transparent);
            background-size: 1rem 1rem;
            text-align: center; 
            line-height: 25px; 
            color: #fffcf5; 
            font-weight: bold;
            font-size: 0.9em;
            transition: width 0.5s ease;
            text-shadow: 1px 1px 0 #3e2723;
        }

        /* Chunk Grid */
        .chunk-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(15px, 1fr)); 
            gap: 2px; 
            margin-top: 20px; 
            padding: 10px;
            border: 1px solid #dcd3c5;
            background: #fffcf5;
        }
        .chunk-card {
            width: 100%; 
            padding-bottom: 100%; /* Aspect ratio 1:1 */
            border: 1px solid #dcd3c5; 
            border-radius: 1px;
            transition: background 0.3s;
            position: relative;
        }
        .chunk-card.waiting { background: #e0dcd0; }
        .chunk-card.processing { background: #d4af37; box-shadow: 0 0 5px #d4af37; z-index: 1; }
        .chunk-card.translated { background: #5d4037; border-color: #3e2723; }
        
        /* Download Button */
        #download-btn {
            display: none; 
            width: 100%; 
            padding: 15px; 
            background-color: #5d4037; 
            color: #fffcf5;
            text-align: center; 
            text-decoration: none; 
            font-size: 1.4em; 
            font-family: 'Rye', serif;
            border: 2px solid #3e2723;
            border-radius: 4px; 
            margin-top: 30px;
            text-transform: uppercase; 
            letter-spacing: 2px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            box-sizing: border-box;
            transition: all 0.2s;
        }
        #download-btn:hover { background-color: #3e2723; transform: translateY(-2px); box-shadow: 0 6px 8px rgba(0,0,0,0.4); }

        /* Preview Area */
        #preview-container {
            margin-top: 30px;
            border: 2px solid #8b7d6b;
            background: #fffcf5;
            padding: 25px;
            box-shadow: inset 0 0 30px rgba(139, 125, 107, 0.1);
            display: none;
            position: relative;
        }
        #preview-container::before {
            content: "TRANSLATION PREVIEW (First 5 Chunks)";
            position: absolute;
            top: -10px;
            left: 20px;
            background: #fffcf5;
            padding: 0 10px;
            font-size: 0.8em;
            color: #5d4037;
            font-weight: bold;
            letter-spacing: 1px;
            font-family: 'Rye', serif;
            border: 1px solid #8b7d6b;
        }
        .preview-item {
            margin-bottom: 15px;
            border-bottom: 1px dashed #dcd3c5;
            padding-bottom: 10px;
        }
        .preview-original {
            font-style: italic;
            color: #795548;
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        .preview-translated {
            font-weight: 600;
            color: #3e2723;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>FlowBook Translator</h1>
    <p class="subtitle">Honoring the author's distinct voice through sophisticated neural cross-lingual mapping.</p>

    <div id="drop-zone">
        <p>Drag your manuscript here or click to upload</p>
        <input type="file" id="file-input" accept=".pdf,.epub">
    </div>

    <div id="status-area">
        <div class="info-bar">
            <span id="lang-display">Language: Detecting...</span>
            <span id="total-chunks-display">Chunks: 0</span>
            <span id="estimated-time-display">Est. Time: --</span>
            <span id="progress-display">Status: Ready</span>
        </div>
        <div class="progress-container">
            <div class="progress-bar" id="global-progress-bar">0%</div>
        </div>
        <div id="preview-container">
            <div id="preview-content"></div>
        </div>
        <div id="chunk-container" class="chunk-grid"></div>
        <a id="download-btn" href="#" target="_blank">Download Translated File</a>
    </div>
</div>

<script>
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const statusArea = document.getElementById('status-area');
    const chunkContainer = document.getElementById('chunk-container');
    const langDisplay = document.getElementById('lang-display');
    const totalChunksDisplay = document.getElementById('total-chunks-display');
    const estimatedTimeDisplay = document.getElementById('estimated-time-display');
    const progressDisplay = document.getElementById('progress-display');
    const globalProgressBar = document.getElementById('global-progress-bar');
    const previewContainer = document.getElementById('preview-container');
    const previewContent = document.getElementById('preview-content');
    const downloadBtn = document.getElementById('download-btn');

    let socket;
    let currentSessionID = null;
    let totalChunks = 0;
    let translatedChunks = 0;
    const CHUNKS_PER_SQUARE = 1000;
    let squareData = [];

    // Drag & Drop Events
    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
    });
    fileInput.addEventListener('change', (e) => { if (e.target.files.length) handleFile(e.target.files[0]); });

    function handleFile(file) {
        // Reset UI
        statusArea.style.display = 'block';
        chunkContainer.innerHTML = '';
        downloadBtn.style.display = 'none';
        langDisplay.textContent = "Language: Detecting...";
        totalChunksDisplay.textContent = "Chunks: 0";
        estimatedTimeDisplay.textContent = "Est. Time: --";
        progressDisplay.textContent = "Status: Uploading...";
        globalProgressBar.style.width = '0%';
        globalProgressBar.textContent = '0%';
        previewContainer.style.display = 'none';
        previewContent.innerHTML = '';
        totalChunks = 0;
        translatedChunks = 0;
        squareData = [];

        // Connect WS
        if (!socket || socket.readyState !== WebSocket.OPEN) {
            socket = new WebSocket("ws://" + window.location.host + "/ws");
            socket.onmessage = handleWSMessage;
            socket.onopen = () => console.log('WebSocket connection established');
            socket.onclose = () => console.log('WebSocket connection closed');
            socket.onerror = (error) => console.error('WebSocket error:', error);
        }

        // Upload
        const formData = new FormData();
        formData.append("book", file);

        fetch("/translate", { method: "POST", body: formData })
            .then(res => res.json())
            .then(data => {
                currentSessionID = data.session_id;
                console.log("Session started:", currentSessionID);
            })
            .catch(err => console.error("Upload failed:", err));
    }

    function updateGlobalProgress() {
        if (totalChunks > 0) {
            const percentage = Math.round((translatedChunks / totalChunks) * 100);
            globalProgressBar.style.width = `${percentage}%`;
            globalProgressBar.textContent = `${percentage}%`;
        } else {
            globalProgressBar.style.width = '0%';
            globalProgressBar.textContent = '0%';
        }
    }

    function handleWSMessage(event) {
        const msg = JSON.parse(event.data);
        if (msg.session_id !== currentSessionID) return;

        // Update Global Status
        if (msg.status !== 'chunk_update') {
            progressDisplay.textContent = msg.message;
        }

        // Language Detection
        if (msg.detected_lang) {
            langDisplay.textContent = "Language: " + msg.detected_lang;
        }

        // Estimated Time
        if (msg.estimated_time) {
            estimatedTimeDisplay.textContent = "Est. Time: " + msg.estimated_time;
        }

        // Initialize Chunks Grid
        if (msg.total_chunks !== undefined && msg.total_chunks > 0) {
            totalChunks = msg.total_chunks;
            totalChunksDisplay.textContent = `Chunks: ${totalChunks}`;
            
            const numSquares = Math.ceil(totalChunks / CHUNKS_PER_SQUARE);
            squareData = new Array(numSquares).fill(0).map(() => ({ translated: 0 }));

            chunkContainer.innerHTML = ''; // Clear previous chunks
            for (let i = 0; i < numSquares; i++) {
                const div = document.createElement('div');
                div.id = `square-${i}`;
                div.className = 'chunk-card waiting';
                div.title = `Chunks ${i * CHUNKS_PER_SQUARE + 1} - ${Math.min((i + 1) * CHUNKS_PER_SQUARE, totalChunks)}`;
                chunkContainer.appendChild(div);
            }
            updateGlobalProgress();
        }

        // Update Chunk Status
        if (msg.status === 'chunk_update') {
            const squareIndex = Math.floor(msg.chunk_index / CHUNKS_PER_SQUARE);
            const el = document.getElementById(`square-${squareIndex}`);
            
            if (msg.chunk_status === 'translated') {
                translatedChunks++;
                updateGlobalProgress();
                
                if (el && squareData[squareIndex]) {
                    squareData[squareIndex].translated++;
                    
                    const totalInSquare = (squareIndex === squareData.length - 1) 
                        ? totalChunks - (squareIndex * CHUNKS_PER_SQUARE) 
                        : CHUNKS_PER_SQUARE;

                    if (squareData[squareIndex].translated >= totalInSquare) {
                        el.className = 'chunk-card translated';
                    } else {
                        el.className = 'chunk-card processing';
                    }

                    // Update Preview (First 5 chunks)
                    if (msg.chunk_index < 5) {
                        previewContainer.style.display = 'block';
                        // Check if paragraph already exists to avoid duplicates
                        if (!document.getElementById(`preview-p-${msg.chunk_index}`)) {
                            const div = document.createElement('div');
                            div.id = `preview-p-${msg.chunk_index}`;
                            div.className = 'preview-item';
                            
                            const originalDiv = document.createElement('div');
                            originalDiv.className = 'preview-original';
                            originalDiv.textContent = msg.original_text;
                            div.appendChild(originalDiv);

                            const translatedDiv = document.createElement('div');
                            translatedDiv.className = 'preview-translated';
                            translatedDiv.textContent = msg.translated_text;
                            div.appendChild(translatedDiv);
                            
                            // Insert in order
                            const paragraphs = previewContent.children;
                            let inserted = false;
                            for (let i = 0; i < paragraphs.length; i++) {
                                const idx = parseInt(paragraphs[i].id.replace('preview-p-', ''), 10);
                                if (msg.chunk_index < idx) {
                                    previewContent.insertBefore(div, paragraphs[i]);
                                    inserted = true;
                                    break;
                                }
                            }
                            if (!inserted) {
                                previewContent.appendChild(div);
                            }
                        }
                    }
                }
            } else if (msg.chunk_status === 'processing') {
                if (el && el.className.includes('waiting')) {
                    el.className = 'chunk-card processing';
                }
            }
        }

        // Completion
        if (msg.status === 'completed' && msg.download_url) {
            downloadBtn.href = msg.download_url;
            downloadBtn.style.display = 'block';
            progressDisplay.textContent = "Status: Completed";
            updateGlobalProgress(); // Ensure 100% on completion
        }
    }
</script>
</body>
</html>